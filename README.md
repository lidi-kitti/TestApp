# Система аутентификации и авторизации

## Описание проекта

Данное приложение представляет собой собственную систему аутентификации и авторизации, реализованную на FastAPI с использованием SQLAlchemy. Система не основана на встроенных возможностях фреймворков, а реализует собственный механизм управления доступом к ресурсам.

## Архитектура системы

### Схема базы данных

Система использует следующую структуру базы данных:

#### Основные таблицы:

1. **users** - Пользователи системы
   - `id` (UUID) - уникальный идентификатор
   - `email` (String) - email пользователя (уникальный)
   - `name` (String) - имя пользователя
   - `hashed_password` (String) - хешированный пароль
   - `is_active` (Boolean) - статус активности аккаунта
   - `created_at` (DateTime) - дата создания
   - `updated_at` (DateTime) - дата обновления

2. **user_sessions** - Сессии пользователей
   - `id` (UUID) - уникальный идентификатор
   - `user_id` (UUID) - ссылка на пользователя
   - `token` (String) - JWT токен сессии
   - `created_at` (DateTime) - дата создания сессии
   - `expires_at` (DateTime) - дата истечения сессии
   - `is_active` (Boolean) - статус активности сессии

3. **roles** - Роли пользователей
   - `id` (UUID) - уникальный идентификатор
   - `name` (String) - название роли
   - `description` (Text) - описание роли
   - `created_at` (DateTime) - дата создания

4. **resources** - Ресурсы системы
   - `id` (UUID) - уникальный идентификатор
   - `name` (String) - название ресурса
   - `description` (Text) - описание ресурса
   - `resource_type` (String) - тип ресурса
   - `created_at` (DateTime) - дата создания

5. **permissions** - Разрешения
   - `id` (UUID) - уникальный идентификатор
   - `name` (String) - название разрешения
   - `action` (Enum) - тип действия (CREATE, READ, UPDATE, DELETE, LIST)
   - `resource_id` (UUID) - ссылка на ресурс
   - `description` (Text) - описание разрешения
   - `created_at` (DateTime) - дата создания

#### Связующие таблицы:

6. **user_roles** - Связь пользователей с ролями
   - `id` (UUID) - уникальный идентификатор
   - `user_id` (UUID) - ссылка на пользователя
   - `role_id` (UUID) - ссылка на роль
   - `assigned_at` (DateTime) - дата назначения

7. **role_permissions** - Связь ролей с разрешениями
   - `id` (UUID) - уникальный идентификатор
   - `role_id` (UUID) - ссылка на роль
   - `permission_id` (UUID) - ссылка на разрешение
   - `assigned_at` (DateTime) - дата назначения

8. **user_permissions** - Прямые разрешения пользователей
   - `id` (UUID) - уникальный идентификатор
   - `user_id` (UUID) - ссылка на пользователя
   - `permission_id` (UUID) - ссылка на разрешение
   - `is_granted` (Boolean) - предоставлено ли разрешение
   - `assigned_at` (DateTime) - дата назначения

### Система разграничения прав доступа

Система реализует гибкую модель управления доступом, основанную на ролях (RBAC) с возможностью прямого назначения разрешений:

#### Принципы работы:

1. **Иерархия разрешений**: Пользователь может получать разрешения через роли или напрямую
2. **Приоритет прямых разрешений**: Прямые разрешения пользователя имеют приоритет над разрешениями ролей
3. **Типы действий**: CREATE, READ, UPDATE, DELETE, LIST
4. **Ресурсы**: users, roles, permissions, products, orders, customers

#### Алгоритм проверки разрешений:

1. Проверяются прямые разрешения пользователя
2. Если прямых разрешений нет, проверяются разрешения через роли
3. Если разрешение найдено и `is_granted=True`, доступ разрешен
4. Если разрешение не найдено, доступ запрещен

### Бизнес-объекты (Mock)

Система включает следующие вымышленные бизнес-объекты:

1. **Products** - Продукты
   - Список продуктов с ценами и категориями
   - Детальная информация о продукте

2. **Orders** - Заказы
   - Список заказов с информацией о клиентах
   - Детальная информация о заказе с товарами

3. **Customers** - Клиенты
   - Список клиентов с контактной информацией
   - Детальная информация о клиенте с историей заказов

## Функциональность

### 1. Взаимодействие с пользователем

#### Регистрация
- **POST** `/api/register`
- Ввод имени, email, пароля, повтор пароля
- Валидация данных и создание аккаунта

#### Вход в систему
- **POST** `/api/login`
- Вход по email и паролю
- Создание JWT токена и сессии

#### Выход из системы
- **POST** `/api/logout`
- Деактивация всех сессий пользователя

#### Профиль пользователя
- **GET** `/api/profile` - получение профиля
- **PUT** `/api/profile` - обновление профиля
- **DELETE** `/api/profile` - мягкое удаление аккаунта

### 2. Система разграничения прав доступа

#### Управление ролями
- **POST** `/api/roles/` - создание роли
- **GET** `/api/roles/` - список ролей
- **GET** `/api/roles/{role_id}` - получение роли

#### Управление ресурсами
- **POST** `/api/resources/` - создание ресурса
- **GET** `/api/resources/` - список ресурсов

#### Управление разрешениями
- **POST** `/api/permissions/` - создание разрешения
- **GET** `/api/permissions/` - список разрешений

#### Назначение ролей и разрешений
- **POST** `/api/user-roles/` - назначение роли пользователю
- **GET** `/api/user-roles/` - список ролей пользователей
- **POST** `/api/user-permissions/` - назначение прямого разрешения
- **GET** `/api/user-permissions/` - список прямых разрешений

### 3. Бизнес-объекты

#### Продукты
- **GET** `/api/products/` - список продуктов
- **GET** `/api/products/{product_id}` - детали продукта

#### Заказы
- **GET** `/api/orders/` - список заказов
- **GET** `/api/orders/{order_id}` - детали заказа

#### Клиенты
- **GET** `/api/customers/` - список клиентов
- **GET** `/api/customers/{customer_id}` - детали клиента

## Установка и запуск

### Требования
- Python 3.8+
- SQLite (или PostgreSQL)

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка окружения
Создайте файл `.env` в корне проекта:
```
DATABASE_URL=sqlite:///./auth_system.db
SECRET_KEY=your-secret-key-here
```

### Инициализация базы данных
```bash
python init_data.py
```

### Запуск приложения
```bash
python main.py
```

Приложение будет доступно по адресу: http://localhost:8000

## Тестовые данные

После инициализации создаются следующие тестовые пользователи:

1. **Администратор**
   - Email: admin@example.com
   - Пароль: admin123
   - Права: полный доступ ко всем ресурсам

2. **Менеджер**
   - Email: manager@example.com
   - Пароль: manager123
   - Права: чтение и создание продуктов, заказов, клиентов

3. **Пользователь**
   - Email: user@example.com
   - Пароль: user123
   - Права: только чтение продуктов, заказов, клиентов

## API Документация

После запуска приложения доступна автоматическая документация:
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## Безопасность

### Аутентификация
- JWT токены с временем жизни 60 минут
- Хеширование паролей с использованием bcrypt
- Сессии с проверкой в базе данных

### Авторизация
- Проверка разрешений на каждый защищенный эндпоинт
- Возврат HTTP 401 при недействительном токене
- Возврат HTTP 403 при отсутствии необходимых разрешений

### Валидация
- Валидация входных данных с помощью Pydantic
- Проверка уникальности email при регистрации
- Валидация паролей

## Структура проекта

```
som/
├── main.py              # Основной файл приложения
├── database.py          # Настройки базы данных
├── models.py            # Модели SQLAlchemy
├── schemas.py           # Pydantic схемы
├── routes.py            # API маршруты
├── dependencies.py      # Зависимости FastAPI
├── permissions.py       # Логика проверки разрешений
├── utils.py             # Утилиты (хеширование, JWT)
├── init_data.py         # Инициализация тестовых данных
├── requirements.txt     # Зависимости Python
└── README.md           # Документация
```

## Особенности реализации

1. **Собственная система аутентификации**: Не использует встроенные возможности FastAPI
2. **Гибкая система разрешений**: Поддержка ролей и прямых разрешений
3. **Мягкое удаление**: Пользователи деактивируются, но не удаляются из БД
4. **Сессии**: JWT токены с проверкой в базе данных
5. **Mock объекты**: Демонстрационные бизнес-объекты для тестирования
6. **Полная документация**: Автоматическая генерация API документации